Vagrant.configure("2") do |config|

  config.vm.boot_timeout = 3600
  config.winrm.retry_limit = 600
  config.winrm.retry_delay = 15
  config.vm.communicator = "winrm"
  config.winrm.username = "vagrant"
  config.winrm.password = "vagrant"

  # EPLAN TCP Service Configuration
  # Change these ports to match your EPLAN TCP server
  EPLAN_SERVICE_BASE_PORT = 8000

  (1..3).each do |i|
    config.vm.define "eplan#{i}" do |node|

      # Lighter Windows Server 2022 for headless service
      node.vm.box = "gusztavvargadr/windows-server-2022-standard"
      node.vm.box_version = "2509.0.0"
      node.vm.hostname = "eplan-service-#{i}"

      # Private network for inter-VM communication
      node.vm.network "private_network",
        ip: "192.168.56.#{100 + i}",
        virtualbox__intnet: "eplan-lan"

      # RDP port (for maintenance only)
      node.vm.network "forwarded_port",
        guest: 3389,
        host: 13389 + i,
        host_ip: "127.0.0.1",
        auto_correct: true

      # EPLAN TCP Service Port
      node.vm.network "forwarded_port",
        guest: EPLAN_SERVICE_BASE_PORT,
        host: EPLAN_SERVICE_BASE_PORT + i - 1,
        host_ip: "0.0.0.0",
        auto_correct: true

      node.vm.provider "virtualbox" do |vb|
        vb.name = "eplan-service-#{i}"

        # Optimized resources for headless service
        vb.memory = 6144  # 6GB RAM (reduced from 16GB)
        vb.cpus = 4       # 4 CPUs (reduced from 8)
        vb.gui = false

        # Minimal graphics for headless
        vb.customize ["modifyvm", :id, "--vram", "32"]
        vb.customize ["modifyvm", :id, "--graphicscontroller", "vboxsvga"]
        vb.customize ["modifyvm", :id, "--accelerate3d", "off"]

        # Disable unnecessary features
        vb.customize ["modifyvm", :id, "--nested-hw-virt", "off"]
        vb.customize ["modifyvm", :id, "--audio", "none"]
        vb.customize ["modifyvm", :id, "--usb", "off"]
      end

      node.vm.provision "shell", path: "install-eplan.ps1"
    end
  end
end