Vagrant.configure("2") do |config|

  config.vm.boot_timeout = 3600
  config.winrm.retry_limit = 600
  config.winrm.retry_delay = 15
  config.vm.communicator = "winrm"
  config.winrm.username = "vagrant"
  config.winrm.password = "vagrant"

  (1..3).each do |i|
    config.vm.define "eplan#{i}" do |node|

      node.vm.box = "gusztavvargadr/windows-10-22h2-enterprise"
      node.vm.box_version = "2202.0.2310"
      node.vm.hostname = "eplan#{i}"

      # FIXED: Use correct syntax for intnet
      node.vm.network "private_network", 
        ip: "192.168.56.#{100 + i}", 
        virtualbox__intnet: "eplan-lan"

      node.vm.network "forwarded_port", 
        guest: 3389, 
        host: 13389 + i, 
        host_ip: "127.0.0.1", 
        auto_correct: true

      node.vm.provider "virtualbox" do |vb|
        vb.name = "eplan#{i}"
        vb.memory = 16384
        vb.cpus = 8
        vb.gui = false
        vb.customize ["modifyvm", :id, "--vram", "256"]
        vb.customize ["modifyvm", :id, "--nested-hw-virt", "on"]
        vb.customize ["modifyvm", :id, "--accelerate3d", "on"]
      end

      node.vm.provision "shell", path: "install-eplan.ps1"
    end
  end
end