# =============================================================================
# Enhanced Industrial Electrical Assistant - Docker Compose
# Server: 192.168.1.68
# Features: Neo4j (Graph), Redis (Cache), CocoIndex (Data Framework), Qdrant (Vector)
# =============================================================================

services:
  # ===========================================================================
  # FRONTEND - React Vite Application (Production Build)
  # ===========================================================================
  frontend:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/simorgh-frontend:${IMAGE_TAG:-latest}
    container_name: frontend
    expose:
      - "80"
    networks:
      - app_net
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:80" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ===========================================================================
  # BACKEND - FastAPI Main Application
  # ===========================================================================
  backend:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/simorgh-backend:${IMAGE_TAG:-latest}
    container_name: backend
    environment:
      - PYTHONUNBUFFERED=1
      # HuggingFace Model Cache - Use cached models first, fallback to download
      - HF_HOME=/root/.cache/huggingface
      - TRANSFORMERS_CACHE=/root/.cache/huggingface/hub
      - SENTENCE_TRANSFORMERS_HOME=/root/.cache/torch/sentence_transformers
      - HF_HUB_OFFLINE=0
      # Neo4j
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-simorgh_secure_2024}
      # Redis
      - REDIS_URL=redis://redis:6379/0
      - REDIS_CHAT_DB=1
      - REDIS_CACHE_DB=2
      # Qdrant
      - QDRANT_URL=http://qdrant:6333
      # CocoIndex (builds from source)
      - COCOINDEX_PIPELINE_DIR=/app/cocoindex_flows
      - COCOINDEX_DATABASE_URL=postgresql://cocoindex:${COCOINDEX_DB_PASSWORD:-cocoindex_2024}@cocoindex_db:5432/cocoindex
      # SQL Server (Auth) - Read Only
      - SQL_SERVER_HOST=${SQL_SERVER_HOST}
      - SQL_SERVER_PORT=${SQL_SERVER_PORT:-1433}
      - SQL_SERVER_USER=${SQL_SERVER_USER}
      - SQL_SERVER_PASSWORD=${SQL_SERVER_PASSWORD}
      - SQL_SERVER_DATABASE=${SQL_SERVER_DATABASE}
      # MySQL TPMS (Auth) - Read Only
      - MYSQL_HOST=${MYSQL_HOST:-192.168.1.148}
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-TPMS}
      # JWT Configuration
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-change-in-production}
      # PostgreSQL Auth Database (Modern Auth)
      - POSTGRES_AUTH_HOST=postgres_auth
      - POSTGRES_AUTH_PORT=5432
      - POSTGRES_AUTH_DATABASE=${POSTGRES_AUTH_DATABASE:-simorgh_auth}
      - POSTGRES_AUTH_USER=${POSTGRES_AUTH_USER:-simorgh}
      - POSTGRES_AUTH_PASSWORD=${POSTGRES_AUTH_PASSWORD:-simorgh_secure_2024}
      # LLM Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      - LOCAL_LLM_URL=http://nginx/api/llm
      - DEFAULT_LLM_MODE=${DEFAULT_LLM_MODE:-online}
      # Document Processor
      - DOC_PROCESSOR_URL=http://doc-processor:8000
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
      - ./backend/cocoindex_flows:/app/cocoindex_flows
      - ./backend/services:/app/services
      - huggingface_cache:/root/.cache/huggingface
      - sentence_transformers_cache:/root/.cache/torch/sentence_transformers
    expose:
      - "8890"
    networks:
      - app_net
    depends_on:
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_started
      cocoindex_db:
        condition: service_healthy
      postgres_auth:
        condition: service_healthy
      doc-processor:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://127.0.0.1:8890/health | grep -q 'healthy' || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # ===========================================================================
  # DOC-PROCESSOR - Document to Markdown Conversion Service
  # ===========================================================================
  doc-processor:
    build:
      context: ./doc-processor
      dockerfile: Dockerfile
    container_name: doc-processor
    expose:
      - "8000"
    volumes:
      - ./uploads/docs:/app/processed_docs
      - ./uploads/temp:/app/temp
    networks:
      - app_net
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://127.0.0.1:8000/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1

  # ===========================================================================
  # STT-SERVICE - Speech-to-Text using Faster-Whisper (CPU)
  # ===========================================================================
  stt-service:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/simorgh-stt-service:${IMAGE_TAG:-latest}
    container_name: stt-service
    expose:
      - "8001"
    volumes:
      - stt_models:/app/models # Cache Whisper models
    networks:
      - app_net
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://127.0.0.1:8001/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s # Model loading takes time
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - WHISPER_MODEL_SIZE=${WHISPER_MODEL_SIZE:-base} # tiny, base, small, medium
      - WHISPER_DEVICE=cpu # Use CPU to avoid GPU memory conflicts
      - WHISPER_COMPUTE_TYPE=int8 # Optimized for CPU

  # ===========================================================================
  # NEO4J - Knowledge Graph Database
  # ===========================================================================
  neo4j:
    image: neo4j:5.15.0-community
    container_name: neo4j
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-simorgh_secure_2024}
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      # Use new setting names (Neo4j 5.x)
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=2G
      - NEO4J_server_memory_pagecache_size=512m
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*,gds.*
    ports:
      - "7474:7474" # HTTP Browser
      - "7687:7687" # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_plugins:/plugins
    networks:
      - app_net
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:7474" ]
      interval: 15s
      timeout: 10s
      retries: 30
      start_period: 180s # GDS plugin download can take time
    restart: unless-stopped

  # ===========================================================================
  # REDIS - Caching & Session Store
  # ===========================================================================
  redis:
    image: redis:7.2-alpine
    container_name: redis
    command: >
      redis-server  --appendonly yes  --maxmemory 512mb  --maxmemory-policy allkeys-lru --save 60 1 --save 300 10
    volumes:
      - redis_data:/data
    expose:
      - "6379"
    networks:
      - app_net
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ===========================================================================
  # QDRANT - Vector Database (Kept for semantic search)
  # ===========================================================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    expose:
      - "6333"
      - "6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    networks:
      - app_net
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped

  # ===========================================================================
  # COCOINDEX - Data Framework for Graph Building
  # Builds from source using python:3.11-bookworm base image
  # ===========================================================================
  cocoindex:
    image: python:3.11-bookworm
    container_name: cocoindex
    restart: unless-stopped
    depends_on:
      cocoindex_db:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    volumes:
      - ./uploads:/docs:ro
      - ./cocoindex_flows:/app
    working_dir: /app
    command: >
      sh -c "
        echo 'Starting CocoIndex setup...' &&
        apt-get update && apt-get install -y git build-essential curl &&
        rm -rf /tmp/coco || true &&
        echo 'Downloading Rust installer...' &&
        (curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y || (echo 'WARNING: Rust install failed - network issue. CocoIndex disabled.' && tail -f /dev/null)) &&
        . /root/.cargo/env &&
        echo 'Cloning CocoIndex...' &&
        (git clone --depth 1 https://github.com/cocoindex-io/cocoindex.git /tmp/coco || (echo 'WARNING: CocoIndex clone failed - network issue. Service disabled.' && tail -f /dev/null)) &&
        cd /tmp/coco &&
        pip install --no-cache-dir . openai &&
        cd /app &&
        echo 'CocoIndex ready - waiting for backend calls' &&
        tail -f /dev/null
      "
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - COCOINDEX_DATABASE_URL=postgresql://cocoindex:${COCOINDEX_DB_PASSWORD:-cocoindex_2024}@cocoindex_db:5432/cocoindex
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-simorgh_secure_2024}
    networks:
      - app_net

  # ===========================================================================
  # COCOINDEX DATABASE - PostgreSQL with pgvector for CocoIndex
  # ===========================================================================
  cocoindex_db:
    image: pgvector/pgvector:pg17
    container_name: cocoindex_db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=cocoindex
      - POSTGRES_PASSWORD=${COCOINDEX_DB_PASSWORD:-cocoindex_2024}
      - POSTGRES_DB=cocoindex
    volumes:
      - cocoindex_db_data:/var/lib/postgresql/data
    expose:
      - "5432"
    networks:
      - app_net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U cocoindex" ]
      interval: 5s
      timeout: 3s
      retries: 5

  # ===========================================================================
  # POSTGRES AUTH - PostgreSQL for Modern Authentication
  # ===========================================================================
  postgres_auth:
    image: postgres:16-alpine
    container_name: postgres_auth
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_AUTH_USER:-simorgh}
      - POSTGRES_PASSWORD=${POSTGRES_AUTH_PASSWORD:-simorgh_secure_2024}
      - POSTGRES_DB=${POSTGRES_AUTH_DATABASE:-simorgh_auth}
    volumes:
      - postgres_auth_data:/var/lib/postgresql/data
      - ./backend/database/migrations/001_create_auth_tables.sql:/docker-entrypoint-initdb.d/001_create_auth_tables.sql:ro
    expose:
      - "5432"
    networks:
      - app_net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_AUTH_USER:-simorgh} -d ${POSTGRES_AUTH_DATABASE:-simorgh_auth}" ]
      interval: 5s
      timeout: 3s
      retries: 5

  # ===========================================================================
  # NGINX - Reverse Proxy (TEMPORARY: HTTP-only mode)
  # ===========================================================================
  # SSL disabled until firewall allows .well-known paths for Let's Encrypt
  # ===========================================================================
  nginx:
    image: nginx:alpine
    container_name: nginx
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_started
    ports:
      - "80:80"    # HTTP only (SSL disabled temporarily)
      # - "443:443"  # HTTPS disabled - uncomment when SSL is available
    environment:
      - TZ=Asia/Tehran
    volumes:
      - ./nginx_configs/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx_configs/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx_configs/includes/locations.inc:/etc/nginx/includes/locations.inc:ro
      - ./static:/usr/share/nginx/html/old:ro
      - certbot_webroot:/var/www/certbot:ro
      - nginx-cache:/data/nginx/cache
      - nginx-logs:/var/log/nginx
    networks:
      - app_net
    restart: unless-stopped

  # ===========================================================================
  # CERTBOT SERVICES - DISABLED (firewall blocks .well-known paths)
  # ===========================================================================
  # To re-enable SSL:
  # 1. Get firewall admin to whitelist /.well-known/acme-challenge/ paths
  # 2. Or obtain DNS access for DNS-01 challenge
  # 3. Uncomment certbot_init, certbot_renew, nginx_reloader below
  # 4. Add nginx dependency on certbot_init
  # 5. Add port 443:443 to nginx
  # 6. Update nginx config to enable HTTPS server blocks
  # ===========================================================================

  # certbot_init:
  #   image: certbot/certbot:latest
  #   container_name: certbot_init
  #   environment:
  #     DOMAIN: ${DOMAIN:-simorghai.electrokavir.com}
  #     CERTBOT_EMAIL: ${CERTBOT_EMAIL:-simorgh.ekc.ai@gmail.com}
  #   ports:
  #     - "80:80"
  #   volumes:
  #     - letsencrypt:/etc/letsencrypt
  #   command: >-
  #     certonly --standalone --preferred-challenges http
  #     --http-01-address 0.0.0.0
  #     -d ${DOMAIN:-simorghai.electrokavir.com}
  #     -m ${CERTBOT_EMAIL:-simorgh.ekc.ai@gmail.com}
  #     --agree-tos --non-interactive --keep-until-expiring
  #   networks:
  #     - app_net
  #   restart: "no"

  # certbot_renew:
  #   image: certbot/certbot:latest
  #   container_name: certbot_renew
  #   depends_on:
  #     certbot_init:
  #       condition: service_completed_successfully
  #   entrypoint: /bin/sh
  #   command: -c "while :; do certbot renew --webroot -w /var/www/certbot; sleep ${RENEW_INTERVAL:-12h}; done"
  #   volumes:
  #     - letsencrypt:/etc/letsencrypt
  #     - certbot_webroot:/var/www/certbot
  #   networks:
  #     - app_net
  #   restart: unless-stopped

  # nginx_reloader:
  #   image: alpine:3.20
  #   container_name: nginx_reloader
  #   depends_on:
  #     - nginx
  #   volumes:
  #     - letsencrypt:/etc/letsencrypt:ro
  #     - /var/run/docker.sock:/var/run/docker.sock
  #   command: >
  #     sh -c '
  #       apk add --no-cache inotify-tools docker-cli >/dev/null;
  #       echo "watch /etc/letsencrypt/live changes";
  #       while :; do
  #         inotifywait -e create,modify,delete,move -r /etc/letsencrypt/live >/dev/null 2>&1;
  #         echo "certs changed: reloading nginx";
  #         docker kill -s HUP nginx >/dev/null 2>&1 || true;
  #       done
  #     '
  #   networks:
  #     - app_net
  #   restart: unless-stopped

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  app_net:
    driver: bridge

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_plugins:
    driver: local
  redis_data:
    driver: local
  qdrant_storage:
    driver: local
  cocoindex_db_data:
    driver: local
  postgres_auth_data:
    driver: local
  stt_models:
    driver: local
  certbot_webroot:
    driver: local
  letsencrypt:
    driver: local
  nginx-cache:
    driver: local
  nginx-logs:
    driver: local
  huggingface_cache:
    driver: local
  sentence_transformers_cache:
    driver: local
