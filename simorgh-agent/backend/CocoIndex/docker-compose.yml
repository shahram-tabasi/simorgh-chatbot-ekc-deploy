services:
  neo4j:
    image: neo4j:2025.08-community-ubi9
    container_name: neo4j
    restart: unless-stopped
    ports:
      - "7474:7474" # Browser
      - "7687:7687" # Bolt
    environment:
      - NEO4J_AUTH=neo4j/cocoindex
      - NEO4J_PLUGINS=["graph-data-science"]
      # Uncomment to enable query logging
      # - NEO4J_db_logs_query_enabled=VERBOSE
      # - NEO4J_db_logs_query_transaction_enabled=VERBOSE
      # - NEO4J_db_logs_query_parameter__logging__enabled=true
      # - NEO4J_dbms_logs_http_enabled=true
      # - NEO4J_server_logs_debug_enabled=true
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-config:/config
      - neo4j-plugins:/plugins
      - ./docs:/import # Your docs folder

  postgres:
    image: pgvector/pgvector:pg17
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: cocoindex
      POSTGRES_USER: cocoindex
      POSTGRES_PASSWORD: cocoindex
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  cocoindex:
    image: python:3.11-bookworm
    container_name: cocoindex
    restart: unless-stopped
    depends_on:
      - neo4j
      - postgres
    volumes:
      - ./docs:/docs:ro # Read-only docs
      - ./cocoindex-pipeline:/app # Your pipeline code
    working_dir: /app
    command: >
      sh -c "
        apt-get update && apt-get install -y git build-essential curl &&
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y &&
        . /root/.cargo/env &&
        rm -rf /tmp/coco || true &&
        git clone --depth 1 https://github.com/cocoindex-io/cocoindex.git /tmp/coco &&
        cd /tmp/coco &&
        pip install --no-cache-dir . openai &&
        cd /app &&
        sleep 15 &&
        cocoindex update pipeline --force
      "
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - COCOINDEX_DATABASE_URL=postgresql://cocoindex:cocoindex@postgres:5432/cocoindex
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=cocoindex

volumes:
  neo4j-data:
  neo4j-logs:
  neo4j-config:
  neo4j-plugins:
  postgres-data:
